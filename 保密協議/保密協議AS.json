{"files":[{"id":"79e6de68-6abb-49ce-ab0d-a73f2e2647b9","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Taipei\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"062a8c3b-89ad-4ddb-ab0b-bd41883863fc","name":"程式碼","type":"server_js","source":"function createContractFromTemplate() {\n  var spreadsheet \u003d SpreadsheetApp.openById(\u00271NrEPHpJoBj7CcG_9WoNcN6iI2snK-jU5jQPFppKEwxs\u0027);\n  var sheet \u003d spreadsheet.getSheetByName(\u0027表單回應\u0027); // 或用 getSheetByName(\u0027表單名稱\u0027)\n  // 取得表單回應的最後一行資料\n  var lastRow \u003d sheet.getLastRow();\n  Logger.log(\"最後一行列數：\" + lastRow);\n  var rowData \u003d sheet.getRange(lastRow, 1, 1, sheet.getLastColumn()).getValues()[0];\n  Logger.log(\"最後一行資料：\" + rowData);\n    var contractData \u003d {\n    \u0027締約日\u0027: Utilities.formatDate(rowData[1], Session.getScriptTimeZone(), \u0027yyyy-MM-dd\u0027),\n    \u0027對方公司名稱全銜\u0027: rowData[2]\n  };\n  Logger.log(\"資料彙整：\" + JSON.stringify(contractData));\n\n  try {\n    // 1. 複製範本\n    const templateId \u003d \u00271CnjmTydWboScy7m6xi9JH_ri_haNL_ivxHuiAf5w8y8\u0027;\n    var templateDoc \u003d DriveApp.getFileById(templateId);\n    var newFile \u003d templateDoc.makeCopy(\u0027保密協議_\u0027 + contractData[\u0027對方公司名稱全銜\u0027]);\n    var newDocId \u003d newFile.getId();\n    Logger.log(\u0027新文件 ID: \u0027 + newDocId);\n\n    // 2. 等待文件準備好\n    var retries \u003d 5;\n    while (retries \u003e 0) {\n      try {\n        //var doc \u003d DocumentApp.openById(newDocId);\n        var doc \u003d DocumentApp.openById(newDocId);\n        Logger.log(doc);\n        break; // 成功開啟文件，跳出迴圈\n      } catch (e) {\n        Logger.log(\"文件未準備好，等待 1 秒後重試...\"+retries);\n        Utilities.sleep(1000);\n        retries--;\n      }\n    }\n    if (retries \u003d\u003d\u003d 0) {\n      throw new Error(\"文件無法開啟，請確認權限或稍後再試。\");\n    }\n\n    Logger.log(\u0027文件已開啟: \u0027 + newDocId);\n    var body \u003d doc.getBody();\n\n    // 3. 替換範本內的變數\n    for (var key in contractData) {\n      var placeholder \u003d \u0027{{\u0027 + key + \u0027}}\u0027;\n      var value \u003d contractData[key] || \u0027\u0027; // 避免 undefined 值\n      Logger.log(\"替換: \" + placeholder + \" → \" + value);\n      body.replaceText(placeholder, value);\n    }\n\n    // 4. 儲存文件\n    doc.saveAndClose();\n    Logger.log(\u0027契約已儲存並關閉: \u0027 + newDocId);\n  } catch (e) {\n    Logger.log(\u0027錯誤訊息: \u0027 + e.message);\n  }\n}\n\n"}]}